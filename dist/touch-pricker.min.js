/**
 * Free Touch Pricker
 * @author Leigh Simpson <code@simpleigh.com>
 * @license GPL-3.0
 * @copyright Copyright 2015-18 Leigh Simpson. All rights reserved.
 * @version 1.0.0
 */

!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Pricker=e()}(this,function(){"use strict";var t=this&&this.__assign||Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++){e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},e=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();!function(e){var n=function(){function n(){}return n.prototype.print=function(n,i){return void 0===i&&(i={}),n=this.templatePath+"."+n,e.Templates[n](t({},i,{object:this}))},n.makePrintable=function(t){t.prototype.print=n.prototype.print},n}();e.PrintableMixin=n}(n||(n={}));!function(t){!function(t){t[t.Triples=7]="Triples",t[t.Caters=9]="Caters",t[t.Cinques=11]="Cinques",t[t.Sextuples=13]="Sextuples",t[t.Septuples=15]="Septuples"}(t.Stage||(t.Stage={}))}(n||(n={}));!function(t){t.rowFromString=function(t,e){var n,i,o={1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,0:10,E:11,T:12,A:13,B:14,C:15},r=[],s=[];if((t=t.toUpperCase()).length>e)throw new Error("Row too long");for(n=1;n<=e;n+=1)r[n]=!1;for(i=0;i<t.length&&i<e;i+=1){if(!((n=o[t.charAt(i)])&&n<=e))throw new Error("Unknown bell");if(r[n])throw new Error("Bell repeated");s.push(n),r[n]=!0}if(t.length<e)for(n=1;n<=e;n+=1)r[n]||s.push(n);return s}}(n||(n={}));!function(t){t.stringFromRow=function(t){for(var e=[],n=0,i=t;n<i.length;n++){var o=i[n];e.push(" 1234567890ETABC".charAt(o))}return e.join("")}}(n||(n={}));!function(t){!function(e){var n=function(){function e(){this._visiting=!0}return e.prototype.visit=function(e,n){return this._rounds||(this._rounds=t.stringFromRow(t.rowFromString("",e.length))),this._visiting&&(this.visitImplementation(e,n),t.stringFromRow(e)===this._rounds&&(this._visiting=!1)),this},e.prototype.isVisiting=function(){return this._visiting},e}();e.AbstractVisitor=n}(t.Visitor||(t.Visitor={}))}(n||(n={}));!function(t){var e=function(){function t(t,e){this._ownership=e,this.templatePath="AbstractBlock",this._initialRow=t.slice()}return t.prototype.getInitialRow=function(){return this._initialRow.slice()},t.prototype.setInitialRow=function(t){return this._initialRow=t.slice(),this.calculate(),this},t.prototype.setOwnership=function(t){return this._ownership=t,this},t.prototype.getContainer=function(){return this._ownership?this._ownership.container:void 0},t.prototype.getIndex=function(){return this._ownership?this._ownership.index:void 0},t.prototype.clearOwnership=function(){return this._ownership=void 0,this},t.prototype.notifyContainer=function(){this._ownership&&this._ownership.container.notify(this._ownership.index)},t}();t.AbstractBlock=e,t.PrintableMixin.makePrintable(e)}(n||(n={}));!function(t){var n=function(t){function n(e,n){var i=t.call(this,e,n)||this;return i._ownership=n,i._blocks=[],i.extend(i.getDefaultLength(e)),i}return e(n,t),n.prototype.calculate=function(){this.calculateBlocks()},n.prototype.getEnd=function(){return this._blocks.length?this._blocks[this._blocks.length-1].getEnd():this._initialRow.slice()},n.prototype.accept=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0,i=this._blocks;n<i.length;n++)for(var o=i[n],r=0,s=t;r<s.length;r++){var a=s[r];o.accept(a)}return this},n.prototype.estimateRows=function(){for(var t=0,e=0,n=this._blocks;e<n.length;e++){t+=n[e].estimateRows()}return t},n.prototype.notify=function(t){this.calculateBlocks(t),this.notifyContainer()},n.prototype.extend=function(t){var e,n=this.getLength(),i=n+t,o=this.getEnd();for(e=n+1;e<=i;e+=1)this._blocks[e-1]=this.createBlock(o,e),o=this._blocks[e-1].getEnd();return this},n.prototype.getDefaultLength=function(t){return 1},n.prototype.calculateBlocks=function(t){void 0===t&&(t=0);var e=this._initialRow;for(t&&(e=this._blocks[t-1].getEnd());t<this.getLength();t+=1)this._blocks[t].setInitialRow(e),e=this._blocks[t].getEnd()},n.prototype.getLength=function(){return this._blocks.length},n.prototype.setLength=function(t){if(t<this.minLength||t>this.maxLength)throw new Error("Length out of range");return t>this.getLength()?this.extend(t-this.getLength()):this._blocks=this._blocks.slice(0,t),this.notifyContainer(),this},n.prototype.safeSetLength=function(t){return t=Math.max(t,this.minLength),t=Math.min(t,this.maxLength),this.setLength(t)},n.prototype.getBlocks=function(){return this._blocks.slice()},n.prototype.getBlock=function(t){if(t<1||t>this.getLength())throw new Error("Block index out of range");return this._blocks[t-1]},n}(t.AbstractBlock);t.AbstractContainer=n}(n||(n={}));!function(t){!function(t){t[t.Plain=0]="Plain",t[t.Bob=1]="Bob",t[t.Single=2]="Single"}(t.Call||(t.Call={}))}(n||(n={}));!function(t){!function(e){function n(t,e){var n;n=t[e],t[e]=t[e+1],t[e+1]=n}function i(t){var e;for(e=0;e<t.length-3;e+=2)n(t,e)}e.permute1=function(t){var e;for(e=1;e<t.length-1;e+=2)n(t,e)},e.permute3=function(t){var e;for(n(t,0),e=3;e<t.length-1;e+=2)n(t,e)},e.permuteN=function(t){var e;for(e=0;e<t.length-1;e+=2)n(t,e)},e.permuteBob=function(t){i(t),n(t,t.length-2)},e.permuteSingle=i,e.permuteCall=function(n,i){i===t.Call.Plain?e.permuteN(n):i===t.Call.Bob?e.permuteBob(n):i===t.Call.Single&&e.permuteSingle(n)}}(t.Changes||(t.Changes={}))}(n||(n={}));!function(t){var n=function(n){function i(e,i){var o=n.call(this,e,i)||this;return o._ownership=i,o._call=t.Call.Plain,o.calculate(),o}return e(i,n),i.prototype.calculate=function(){this._end=this._initialRow.slice(),t.Changes.permuteCall(this._end,this._call),this.applySixTransposition()},i.prototype.getEnd=function(){return this._end.slice()},i.prototype.estimateRows=function(){return 6},i.prototype.getStartRow=function(){var e=this._initialRow.slice();return t.Changes.permuteCall(e,this._call),e},i.prototype.getCall=function(){return this._call},i.prototype.setCall=function(t,e){return void 0===e&&(e=!0),this._call=t,e&&(this.calculate(),this.notifyContainer()),this},i.prototype.toggleCall=function(){var t=(this._call+1)%3;return this.setCall(t),t},i}(t.AbstractBlock);t.AbstractSix=n}(n||(n={}));!function(t){var e=function(){function e(){this._directory=[]}return e.prototype.add=function(t){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];var o,r;if("object"==typeof t?n=e.getIndices(t):n.unshift(t),!(r=n.pop()))throw new Error("Bad ownership: must have at least one index");o=this._directory;for(var s=0,a=n;s<a.length;s++){var c=a[s];o[c]||(o[c]=[]),o=o[c]}return o[r]=!0,this},e.prototype.contains=function(t){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];var o;"object"==typeof t?n=e.getIndices(t):n.unshift(t),o=this._directory;for(var r=0,s=n;r<s.length;r++){var a=s[r];if(!o[a])return!1;o=o[a]}return!0},e.getIndices=function(e){var n,i,o=[];if(i=e.getIndex(),!(n=e.getContainer()))throw new Error("Bad ownership: block has no container");for(;n instanceof t.AbstractBlock;){if(!i)throw new Error("Bad ownership: container but no index");o.unshift(i),i=n.getIndex(),n=n.getContainer()}return o},e.prototype.isEmpty=function(){return!this._directory.length},e}();t.BlockDirectory=e}(n||(n={}));!function(t){var n=function(n){function i(){var t=null!==n&&n.apply(this,arguments)||this;return t.templatePath="Course",t.minLength=2,t.maxLength=60,t.getSixes=t.getBlocks,t.getSix=t.getBlock,t}return e(i,n),i.prototype.getDefaultLength=function(t){return 2*t.length},i.prototype.createBlock=function(e,n){return n%2?new t.Slow(e,{container:this,index:n}):new t.Quick(e,{container:this,index:n})},i.prototype.resetLength=function(){return this.setLength(this.getDefaultLength(this._initialRow)),this},i.prototype.resetCalls=function(){for(var e=0,n=this._blocks;e<n.length;e++){n[e].setCall(t.Call.Plain,!1)}return this.getSix(1).setCall(t.Call.Plain),this},i.prototype.isPlain=function(){for(var t=0,e=this._blocks;t<e.length;t++){if(e[t].getCall())return!1}return!0},i.prototype.clone=function(){var t=new i(this._initialRow);t.setLength(this.getLength());for(var e=1;e<=this.getLength();e+=1)t.getSix(e).setCall(this.getSix(e).getCall(),!1);return t.getSix(1).setCall(this.getSix(1).getCall()),t},i.fromString=function(e,n){var o,r,s,a=new i(e),c=new RegExp("^\\s*(?:[0-9a-z]{3,15}\\s+)?((?:\\d{1,2}|\\d{1,2}s|s\\d{1,2})(?:[\\s.,]+(?:\\d{1,2}|\\d{1,2}s|s\\d{1,2}))*|p)(?:\\s+\\((\\d{1,2})[^\\d\\)]*\\))?\\s*$","i").exec(n);if(!c)throw new Error("Cannot import course");if(c[2]&&a.setLength(parseInt(c[2])),"p"===c[1])return a;for(o=c[1].split(new RegExp("[\\s.,]+")),r=0;r<o.length;r+=1)"s"===(s=o[r]).charAt(0)?(s=s.slice(1),a.getSix(parseInt(s)).setCall(t.Call.Single)):"s"===s.slice(-1)?(s=s.slice(0,-1),a.getSix(parseInt(s)).setCall(t.Call.Single)):a.getSix(parseInt(s)).setCall(t.Call.Bob);return a},i}(t.AbstractContainer);t.Course=n}(n||(n={}));!function(t){!function(t){function e(t,e){var n;return"auto"===(n=window.getComputedStyle?getComputedStyle(t)[e]:t.currentStyle[e])?0:parseInt(n)+1}t.getWidth=function(t){return t.offsetWidth+1+e(t,"marginLeft")+e(t,"marginRight")},t.getHeight=function(t){return t.offsetHeight+1+e(t,"marginTop")+e(t,"marginBottom")}}(t.Dom||(t.Dom={}))}(n||(n={}));!function(t){t.Templates={}}(n||(n={}));!function(t){!function(e){var n=function(){function e(t){this._iframe=t}return e.prototype.resize=function(){if(this._iframe){for(var e=this._iframe.contentWindow.document.body.children,n=0,i=0,o=0;o<e.length;o+=1){var r=e[o];n+=t.Dom.getWidth(r),i=Math.max(i,t.Dom.getHeight(r))}this._iframe.width=n+"px",this._iframe.height=i+"px"}},e.prototype.getEl=function(t){return(this._iframe?this._iframe.contentWindow.document:document).getElementById(t)},e}();e.AbstractPricker=n}(t.Pricker||(t.Pricker={}))}(n||(n={}));!function(t){var n=function(n){function i(){var t=null!==n&&n.apply(this,arguments)||this;return t.templatePath="Touch",t.minLength=0,t.maxLength=100,t.getCourses=t.getBlocks,t.getCourse=t.getBlock,t}return e(i,n),i.prototype.accept=function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];var o=this._initialRow.slice();t.Changes.permute1(o);for(var r=0,s=e;r<s.length;r++){var a=s[r];a.visit(o),a.visit(this._initialRow)}return n.prototype.accept.apply(this,e)},i.prototype.estimateRows=function(){return 2+n.prototype.estimateRows.call(this)},i.prototype.getDefaultLength=function(t){return 0},i.prototype.createBlock=function(e,n){return new t.Course(e,{container:this,index:n})},i.prototype.insertCourse=function(t,e){return this._blocks.splice(t-1,0,e),this.fixupOwnership(t),this.notify(t-1),this},i.prototype.deleteCourse=function(t){var e=this.getCourse(t);return this._blocks.splice(t-1,1),e.clearOwnership(),this.fixupOwnership(t),this.notify(t-1),e},i.prototype.fixupOwnership=function(t){for(var e=t;e<=this.getLength();e+=1)this.getCourse(e).setOwnership({container:this,index:e})},i.fromString=function(e){var n,o,r,s,a=e.split("\n");for(n=0;n<a.length;n+=1)if(o=a[n],o=o.replace(/\/\/.*$/,""),o=o.replace(/^\//,""),!/^\s*$/.test(o))if(s)r=t.Course.fromString(s.getEnd(),o),s.insertCourse(s.getLength()+1,r);else{if(o=o.replace(/\s/g,""),!t.Stage[o.length])throw new Error("Cannot recognise stage");s=new i(t.rowFromString("231",o.length))}if(!s)throw new Error("No input lines");return s},i}(t.AbstractContainer);t.Touch=n}(n||(n={}));!function(t){!function(e){var n=function(){function e(e){this._stage=e,this.templatePath="Music.AbstractScheme",this._matchers=this.createMatchers(t.stringFromRow(t.rowFromString("",e)))}return e.prototype.match=function(t){for(var e=!1,n=0,i=this._matchers;n<i.length;n++){var o=i[n];if(o){var r=o.match(t);e=e||r}}return e},e.prototype.getMatchCount=function(){for(var t=0,e=0,n=this._matchers;e<n.length;e++){var i=n[e];i&&(t+=i.getMatchCount())}return t},e.prototype.getMatchers=function(){return this._matchers.slice()},e}();e.AbstractScheme=n,t.PrintableMixin.makePrintable(n)}(t.Music||(t.Music={}))}(n||(n={}));!function(t){!function(t){!function(t){t[t.Back=-1]="Back",t[t.Row=0]="Row",t[t.Front=1]="Front"}(t.MatchType||(t.MatchType={}))}(t.Music||(t.Music={}))}(n||(n={}));!function(t){!function(e){var n=function(){function t(t,n,i){void 0===i&&(i=e.MatchType.Back),this._pattern=t,this._name=n,this._type=i,this._matchCount=0,this.templatePath="Music.Pattern"}return t.prototype.match=function(t){return this._type===e.MatchType.Back?t=t.slice(-this._pattern.length):this._type===e.MatchType.Front&&(t=t.slice(0,this._pattern.length)),t===this._pattern&&(this._matchCount+=1,!0)},t.prototype.getName=function(){return void 0===this._name?this._pattern:this._name},t.prototype.getMatchCount=function(){return this._matchCount},t.prototype.isWildcardMatch=function(){return this._type!==e.MatchType.Row},t}();e.Pattern=n,t.PrintableMixin.makePrintable(n)}(t.Music||(t.Music={}))}(n||(n={}));!function(t){!function(e){var n=function(){function t(t,e,n){this._name=t,this._parentPattern=n,this.templatePath="Music.PatternGroup",this._patterns=e.slice()}return t.prototype.match=function(t){for(var e=!1,n=0,i=this._patterns;n<i.length;n++){var o=i[n];if(o){var r=o.match(t);e=e||r}}return this._parentPattern&&this._parentPattern.match(t),e},t.prototype.getName=function(){return this._name},t.prototype.getMatchCount=function(){return this._parentPattern?this._parentPattern.getMatchCount():this.getSubmatchCount()},t.prototype.getPatterns=function(){return this._patterns.slice()},t.prototype.getSubmatchCount=function(){for(var t=0,e=0,n=this._patterns;e<n.length;e++){var i=n[e];i&&(t+=i.getMatchCount())}return t},t}();e.PatternGroup=n,t.PrintableMixin.makePrintable(n)}(t.Music||(t.Music={}))}(n||(n={}));!function(t){!function(n){var i=function(i){function o(){return null!==i&&i.apply(this,arguments)||this}return e(o,i),o.prototype.getName=function(){return"MBD scheme"},o.prototype.createMatchers=function(e){var i,o,r=[];i=e.slice(4-this._stage),r.push(new n.Pattern(i)),i=e.slice(4-this._stage,-2)+e.slice(-1)+e.slice(-2,-1),r.push(new n.Pattern(i)),i="65"+e.slice(6-this._stage),r.push(new n.Pattern(i)),o=[];for(s=0;s<this._stage-1;s+=1)i=e.slice(0,s)+e.charAt(s+1)+e.charAt(s)+e.slice(s+2),o.push(new n.Pattern(i,e.charAt(s+1)+e.charAt(s),n.MatchType.Row));switch(r.push(new n.PatternGroup("near misses",o)),this._stage){case t.Stage.Triples:r.push(new n.PatternGroup("468",[new n.Pattern("246","2468"),new n.Pattern("75346","753468"),new n.Pattern("1357246","Queens",n.MatchType.Row),new n.Pattern("7531246","Reverse Queens",n.MatchType.Row),new n.Pattern("1275346","Whittingtons",n.MatchType.Row)],new n.Pattern("46")));break;case t.Stage.Caters:r.push(new n.PatternGroup("680",[new n.Pattern("468","4680"),new n.Pattern("97568","975680"),new n.Pattern("135792468","Queens",n.MatchType.Row),new n.Pattern("975312468","Reverse Queens",n.MatchType.Row),new n.Pattern("123497568","Whittingtons",n.MatchType.Row)],new n.Pattern("68")));break;case t.Stage.Cinques:r.push(new n.PatternGroup("80T",[new n.Pattern("680","680T"),new n.Pattern("E9780","E9780T"),new n.Pattern("13579E24680","Queens",n.MatchType.Row),new n.Pattern("E9753124680","Reverse Queens",n.MatchType.Row),new n.Pattern("531246E9780","Double Whittingtons",n.MatchType.Row)],new n.Pattern("80")));break;case t.Stage.Sextuples:r.push(new n.PatternGroup("0TB",[new n.Pattern("80T","80TB"),new n.Pattern("AE90T","AE90TB"),new n.Pattern("13579EA24680T","Queens",n.MatchType.Row),new n.Pattern("AE9753124680T","Reverse Queens",n.MatchType.Row)],new n.Pattern("0T")));break;case t.Stage.Septuples:r.push(new n.PatternGroup("TB",[new n.Pattern("0TB"),new n.Pattern("CAETB"),new n.Pattern("13579EAC24680TB","Queens",n.MatchType.Row),new n.Pattern("CAE9753124680TB","Reverse Queens",n.MatchType.Row)],new n.Pattern("TB")))}if(r.push(new n.PatternGroup("front LB5",[new n.Pattern("12345","12345",n.MatchType.Front),new n.Pattern("54321","54321",n.MatchType.Front),new n.Pattern("23456","23456",n.MatchType.Front),new n.Pattern("65432","65432",n.MatchType.Front)])),r.push(new n.PatternGroup("back LB5",[new n.Pattern("12345","12345",n.MatchType.Back),new n.Pattern("54321","54321",n.MatchType.Back),new n.Pattern("23456","23456",n.MatchType.Back),new n.Pattern("65432","65432",n.MatchType.Back)])),r.push(new n.PatternGroup("front LB4",[new n.Pattern("1234","1234",n.MatchType.Front),new n.Pattern("4321","4321",n.MatchType.Front),new n.Pattern("2345","2345",n.MatchType.Front),new n.Pattern("5432","5432",n.MatchType.Front),new n.Pattern("3456","3456",n.MatchType.Front),new n.Pattern("6543","6543",n.MatchType.Front)])),r.push(new n.PatternGroup("back LB4",[new n.Pattern("1234","1234",n.MatchType.Back),new n.Pattern("4321","4321",n.MatchType.Back),new n.Pattern("2345","2345",n.MatchType.Back),new n.Pattern("5432","5432",n.MatchType.Back),new n.Pattern("3456","3456",n.MatchType.Back),new n.Pattern("6543","6543",n.MatchType.Back)])),this._stage===t.Stage.Triples)r.push(new n.PatternGroup("reverse rollups",[new n.Pattern("7654")]));else{o=[];for(var s=this._stage-8;s>=0;s-=1)i=(i=e.split("").reverse().join("")).slice(s,s+4),o.push(new n.Pattern(i));r.push(new n.PatternGroup("reverse rollups",o))}return r},o}(n.AbstractScheme);n.MbdScheme=i}(t.Music||(t.Music={}))}(n||(n={}));!function(t){!function(t){var n=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e._count=0,e}return e(n,t),n.prototype.getCount=function(){return this._count},n.prototype.visitImplementation=function(t,e){this._count+=1},n}(t.AbstractVisitor);t.Counter=n}(t.Visitor||(t.Visitor={}))}(n||(n={}));!function(t){!function(n){var i=function(n){function i(e){var i=n.call(this)||this;return i._matcher=e,i._directory=new t.BlockDirectory,i}return e(i,n),i.prototype.getMatcher=function(){return this._matcher},i.prototype.getDirectory=function(){return this._directory},i.prototype.visitImplementation=function(e,n){this._matcher.match(t.stringFromRow(e))&&n&&this._directory.add(n)},i}(n.AbstractVisitor);n.Music=i}(t.Visitor||(t.Visitor={}))}(n||(n={}));!function(t){!function(n){var i=function(n){function i(){var e=null!==n&&n.apply(this,arguments)||this;return e._rowCounts={},e._directory=new t.BlockDirectory,e._isTrue=!0,e}return e(i,n),i.prototype.getRowCounts=function(){var t={};for(var e in this._rowCounts)this._rowCounts.hasOwnProperty(e)&&(t[e]=this._rowCounts[e].length);return t},i.prototype.getDirectory=function(){return this._directory},i.prototype.isTrue=function(){return this._isTrue},i.prototype.visitImplementation=function(e,n){var i=t.stringFromRow(e);if(i in this._rowCounts){if(1===this._rowCounts[i].length){var o=this._rowCounts[i][0];o&&this._directory.add(o)}this._isTrue=!1,n&&this._directory.add(n),this._rowCounts[i].push(n)}else this._rowCounts[i]=[n]},i}(n.AbstractVisitor);n.Proof=i}(t.Visitor||(t.Visitor={}))}(n||(n={}));!function(t){var n;!function(t){t[t.Course=0]="Course",t[t.Touch=1]="Touch"}(n||(n={}));!function(i){var o=function(i){function o(){var t=null!==i&&i.apply(this,arguments)||this;return t._showSixHeads=!1,t._selectedIndex=0,t.templatePath="Pricker.Mbd",t}return e(o,i),o.prototype.notify=function(t){t===n.Course?(this._extraSixes.setInitialRow(this._course.getEnd()),this._copiedIndex=void 0):t===n.Touch&&(this._rowCount=void 0,this._proofText=void 0,this._falseness=void 0,this._music=void 0),this.redraw()},o.prototype.onLoad=function(){for(var e,n=t.Stage.Triples;n<=t.Stage.Septuples;n+=2)(e=document.createElement("option")).value=n.toString(),e.innerText=t.Stage[n],this.getEl("stage").appendChild(e);this.getEl("stage").value=t.Stage.Cinques.toString(),this.onStage()},o.prototype.onStage=function(){this._stage=parseInt(this.getEl("stage").value),this._initialRow=t.rowFromString("231",this._stage),this._course=new t.Course(this._initialRow,{container:this,index:n.Course}),this._extraSixes=new t.Course(this._initialRow),this._extraSixes.setLength(8),this._touch=new t.Touch(this._initialRow,{container:this,index:n.Touch}),this._musicScheme=new t.Music.MbdScheme(this._stage),this.redraw()},o.prototype.redraw=function(){var e=this._course.clone();this._extraSixes.setInitialRow(this._course.getEnd()),this.getEl("sixends").innerHTML=this._course.print("mbd",{falseness:this._falseness,music:this._music,courseIndex:this._copiedIndex,extraSixes:this._extraSixes,showSixHeads:this._showSixHeads}),this.getEl("calling").innerHTML=this._course.print("html"),e.setInitialRow(this._initialRow),this.getEl("callingFromRounds").innerHTML=e.print("html"),this.getEl("initialRow").value=t.stringFromRow(this._course.getInitialRow()),this.getEl("courseLength").value=this._course.getLength().toString(),this._savedCourse?this.getEl("savedCalling").innerHTML=this._savedCourse.print("html"):this.getEl("savedCalling").innerText="None",this.getEl("proofResult").innerText=this._proofText||"",this._rowCount?this.getEl("numRows").innerText=this._rowCount+" Stedman "+t.Stage[this._stage]:this.getEl("numRows").innerText=this._touch.estimateRows()+" changes",this.getEl("courses").outerHTML='<select id="courses" onclick="pricker.onSelectCourse()" ondblclick="pricker.onCopyCourse()">'+this._touch.print("select",{touchRows:this._rowCount,styleUnreached:"color:gray",falseness:this._falseness,styleFalse:"color:red"})+"</select>",this.getEl("courses").size=Math.max(this._touch.getLength()+1,2),this.getEl("courses").value=this._selectedIndex.toString(),this.resize()},o.prototype.c=function(t){this._course.getSix(t).toggleCall()},o.prototype.onSetInitialRow=function(){var e,n=this.getEl("initialRow").value;try{e=t.rowFromString(n,this._stage)}catch(t){return}this._course.setInitialRow(e),this._extraSixes.setInitialRow(this._course.getEnd()),this.redraw()},o.prototype.onResetInitialRow=function(){this._course.setInitialRow(this._initialRow),this._extraSixes.setInitialRow(this._course.getEnd()),this.redraw()},o.prototype.onSetLength=function(){var t=this.getEl("courseLength").value,e=parseInt(t);e&&this._course.safeSetLength(e-e%2)},o.prototype.onResetLength=function(){this._course.resetLength()},o.prototype.onResetCalls=function(){this._course.resetCalls()},o.prototype.onSaveCalling=function(){this._savedCourse=this._course.clone(),this._savedCourse.setInitialRow(this._initialRow),this.redraw()},o.prototype.onLoadCalling=function(){this._savedCourse?(this._course=this._savedCourse.clone(),this._course.setInitialRow(this._initialRow)):this._course=new t.Course(this._initialRow),this._course.setOwnership({container:this,index:n.Course}),this.redraw()},o.prototype.onSelectCourse=function(){var t=this.getEl("courses").value;this._selectedIndex=parseInt(t)},o.prototype.onInsertCourse=function(){this._selectedIndex+=1,this._touch.insertCourse(this._selectedIndex,this._course.clone()),this.getEl("rolling").checked&&(this._course.setInitialRow(this._touch.getCourse(this._selectedIndex).getEnd()),this._course.resetLength(),this._course.resetCalls())},o.prototype.onPasteCourse=function(){this._selectedIndex&&(this._touch.deleteCourse(this._selectedIndex),this._touch.insertCourse(this._selectedIndex,this._course.clone()),this.getEl("rolling").checked&&(this._course.setInitialRow(this._touch.getCourse(this._selectedIndex).getEnd()),this._selectedIndex=Math.min(this._selectedIndex+1,this._touch.getLength()),this._course.resetLength(),this._course.resetCalls()))},o.prototype.onCopyCourse=function(){this._selectedIndex&&(this._course=this._touch.getCourse(this._selectedIndex).clone(),this._course.setOwnership({container:this,index:n.Course}),this._copiedIndex=this._selectedIndex,this.redraw())},o.prototype.onCutCourse=function(){this.onCopyCourse(),this.onDeleteCourse()},o.prototype.onDeleteCourse=function(){this._selectedIndex&&(this._touch.deleteCourse(this._selectedIndex),this._selectedIndex=Math.min(this._selectedIndex,this._touch.getLength()),this.redraw())},o.prototype.onLoadTouch=function(){var e,i=this.getEl("loadSaveTextarea").value;try{e=t.Touch.fromString(i)}catch(t){return}this._stage=e.getInitialRow().length,this.getEl("stage").value=this._stage.toString(),this.onStage(),this._touch=e,this._touch.setOwnership({container:this,index:n.Touch}),this.redraw()},o.prototype.onSaveTouch=function(){this.getEl("loadSaveTextarea").innerText=this._touch.print("text")},o.prototype.onGenerateSiril=function(){this.getEl("sirilTextarea").innerText=this._touch.print("siril",{touchRows:this._rowCount})},o.prototype.onAnalyseMusic=function(){var e=new t.Visitor.Music(this._musicScheme);this._touch.accept(e),this.getEl("musicTextarea").innerText=e.getMatcher().print("text"),this._music=e.getDirectory()},o.prototype.onShowSixHeads=function(){var t=this.getEl("showSixHeads");this._showSixHeads=t.checked,this.redraw()},o.prototype.onProve=function(){var e=new t.Visitor.Proof,n=new t.Visitor.Counter;return this._touch.accept(e,n),this._rowCount=n.getCount(),this._falseness=e.getDirectory(),e.isTrue()?e.isVisiting()?this._proofText="True, but doesn't come round":this._proofText="Composition is true":this._proofText="Composition is FALSE",this.redraw(),e.isTrue()},o.prototype.onTab=function(t){for(var e=this.getEl("tabs").children,n=this.getEl("tab_"+t),i=this.getEl("pages").children,o=this.getEl("page_"+t),r=0;r<e.length;r+=1)e[r].className="tab";n.className="tab tab-selected";for(r=0;r<i.length;r+=1)i[r].className="page";o.className="page page-selected",this.resize()},o}(i.AbstractPricker);i.Mbd=o,t.PrintableMixin.makePrintable(o)}(t.Pricker||(t.Pricker={}))}(n||(n={}));!function(t){!function(t){t.createAndAppendStyle=function(t,e){void 0===t&&(t=document),void 0===e&&(e="");var n=t.createElement("style");return n.type="text/css",n.innerText=e,t.head.appendChild(n),n}}(t.Dom||(t.Dom={}))}(n||(n={}));!function(t){!function(t){t.createIframe=function(t){void 0===t&&(t=document);var e=t.createElement("iframe");return e.frameBorder="0",e.scrolling="no",e.src="about:blank",e.style.border="none",e}}(t.Dom||(t.Dom={}))}(n||(n={}));!function(t){!function(t){t.injectIframeData=function(t,e,n){void 0===e&&(e=""),void 0===n&&(n={});var i=t.contentWindow.document;i.open();for(var o in n)n.hasOwnProperty(o)&&(t.contentWindow[o]=n[o]);i.write(e),i.close()}}(t.Dom||(t.Dom={}))}(n||(n={}));!function(t){t.create=function(e,n,i){void 0===n&&(n={}),void 0===i&&(i=document);var o,r=i.getElementById(e);if(!r)throw new Error("Cannot find HTML element: '"+e+"'");if(n.iframe||void 0===n.iframe){var s=t.Dom.createIframe(i);r.appendChild(s),o=new t.Pricker.Mbd(s),t.Dom.injectIframeData(s,t.Templates.create({pricker:o}),{pricker:o})}else o=new t.Pricker.Mbd,t.Dom.createAndAppendStyle(i,o.print("css")),r.innerHTML=o.print("html"),window.pricker=o,i===document&&o.onLoad();return o}}(n||(n={}));!function(t){var n=function(n){function i(){var t=null!==n&&n.apply(this,arguments)||this;return t.templatePath="Quick",t}return e(i,n),i.prototype.accept=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];for(var i=this.getInitialRow(),o=0,r=e;o<r.length;o++){var s=r[o];t.Changes.permuteCall(i,this._call),s.visit(i,this),t.Changes.permute1(i),s.visit(i,this),t.Changes.permute3(i),s.visit(i,this),t.Changes.permute1(i),s.visit(i,this),t.Changes.permute3(i),s.visit(i,this),s.visit(this._end,this)}return this},i.prototype.applySixTransposition=function(){t.Changes.permute3(this._end)},i}(t.AbstractSix);t.Quick=n}(n||(n={}));!function(t){var n=function(n){function i(){var t=null!==n&&n.apply(this,arguments)||this;return t.templatePath="Slow",t}return e(i,n),i.prototype.accept=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];for(var i=this.getInitialRow(),o=0,r=e;o<r.length;o++){var s=r[o];t.Changes.permuteCall(i,this._call),s.visit(i,this),t.Changes.permute3(i),s.visit(i,this),t.Changes.permute1(i),s.visit(i,this),t.Changes.permute3(i),s.visit(i,this),t.Changes.permute1(i),s.visit(i,this),s.visit(this._end,this)}return this},i.prototype.applySixTransposition=function(){t.Changes.permute1(this._end)},i}(t.AbstractSix);t.Slow=n}(n||(n={}));!function(t){!function(t){var n=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return e(n,t),n.prototype.getName=function(){return"Custom scheme"},n.prototype.createMatchers=function(t){return[]},n.prototype.addMatcher=function(t){this._matchers.push(t)},n}(t.AbstractScheme);t.CustomScheme=n}(t.Music||(t.Music={}))}(n||(n={}));!function(t){!function(n){var i=function(n){function i(){return null!==n&&n.apply(this,arguments)||this}return e(i,n),i.prototype.visitImplementation=function(e,n){console.log(t.stringFromRow(e))},i}(n.AbstractVisitor);n.Console=i}(t.Visitor||(t.Visitor={}))}(n||(n={}));var n;return function(t){!function(n){var i=function(n){function i(){var t=null!==n&&n.apply(this,arguments)||this;return t._strings=[],t}return e(i,n),i.prototype.getStrings=function(){return this._strings.slice()},i.prototype.visitImplementation=function(e,n){this._strings.push(t.stringFromRow(e))},i}(n.AbstractVisitor);n.StringArray=i}(t.Visitor||(t.Visitor={}))}(n||(n={})),n.Templates.create=function(t){return'<!DOCTYPE html><html> <head> <title>Free Touch Pricker</title> <style type="text/css"> body { margin: 0px; padding: 0px; } '+t.pricker.print("css")+' </style> <script type="text/javascript"> window.onload = function () { pricker.onLoad(); }; <\/script> </head> <body> '+t.pricker.print("html")+" </body></html>"},n.Templates["AbstractSix.mbd"]=function(t){var e="";if(!0!==t.underline&&(t.underline=!1),t.falseness&&t.courseIndex&&t.falseness.contains(t.courseIndex,t.object.getIndex()))i="falseBlock";else if(t.music&&t.courseIndex&&t.music.contains(t.courseIndex,t.object.getIndex()))i="musicalBlock";else var i="";return e+='<span class="'+i+'">',t.showSixHeads?e+=""+n.stringFromRow(t.object.getStartRow()):(t.underline&&(e+="<u>"),e+=""+n.stringFromRow(t.object.getEnd()),t.underline&&(e+="</u>")),e+='</span>&nbsp;&nbsp;<span class="'+t.type+'Six" onclick="pricker.c('+t.object.getIndex()+')">&nbsp;',t.object.getCall()===n.Call.Plain?e+="&nbsp;":t.object.getCall()===n.Call.Bob?e+="-":t.object.getCall()===n.Call.Single&&(e+="s"),e+="&nbsp;</span>&nbsp;&nbsp;"+t.object.getIndex()+"<br />",t.showSixHeads&&(e+='<span class="'+i+'"><u>'+n.stringFromRow(t.object.getEnd())+"</u></span><br />"),e},n.Templates["AbstractSix.siril"]=function(t){var e="";return t.touchRows=t.touchRows||1/0,t.object.getCall()===n.Call.Plain?e+="plain":t.object.getCall()===n.Call.Bob?e+="bob":t.object.getCall()===n.Call.Single&&(e+="single"),e+=", ",t.touchRows>1&&(t.touchRows>=6?e+=""+t.type:e+="+"+t.notation.slice(0,t.touchRows-1).join("."),e+=", "),e},n.Templates["Course.html"]=function(t){return"<u>"+n.stringFromRow(t.object.getInitialRow())+"</u><br />"+t.object.print("text")},n.Templates["Course.mbd"]=function(t){var e="<u>"+n.stringFromRow(t.object.getInitialRow())+"</u><br />",i=t.object.getSixes();if(i)for(var o=-1,r=i.length-1;o<r;)(a=i[o+=1]).getIndex()===t.object.getLength()&&(t.underline=!0),e+=""+a.print("mbd",t);if(t.extraSixes){var s=t.extraSixes.getSixes();if(s)for(var a,c=-1,u=s.length-1;c<u;)a=s[c+=1],e+='<span class="extraSix">'+n.stringFromRow(a.getEnd())+"</span><br />"}return e},n.Templates["Course.siril"]=function(t){var e="";t.touchRows=t.touchRows||1/0;var n=t.object.getSixes();if(n)for(var i,o=-1,r=n.length-1;o<r&&(i=n[o+=1],e+=""+i.print("siril",{touchRows:t.touchRows}),t.touchRows-=i.estimateRows(),!(t.touchRows<=0)););return e+='"@  '+t.object.print("text",{courseEnd:!1})+'"\n'},n.Templates["Course.text"]=function(t){var e="",i=[];t.end=t.end||"",void 0===t.courseEnd&&(t.courseEnd=!0),t.courseEnd&&(e+=n.stringFromRow(t.object.getEnd())+"  ");var o=t.object.getSixes();if(o)for(var r,s=-1,a=o.length-1;s<a;)(r=o[s+=1]).getCall()&&i.push((r.getCall()===n.Call.Single?"s":"")+r.getIndex());return i.length?e+=""+i.join(" "):e+="p",t.object.getLength()!==2*t.object.getInitialRow().length&&(e+="  ("+t.object.getLength()+" sixes)"),e+=""+t.end},n.Templates["Quick.mbd"]=function(t){var e="";return t.type="quick",e+=""+n.Templates["AbstractSix.mbd"](t)},n.Templates["Quick.siril"]=function(t){var e="";return t.type="quick",t.notation=["1","3","1","3"],e+=""+n.Templates["AbstractSix.siril"](t)},n.Templates["Slow.mbd"]=function(t){var e="";return t.type="slow",e+=""+n.Templates["AbstractSix.mbd"](t)},n.Templates["Slow.siril"]=function(t){var e="";return t.type="slow",t.notation=["3","1","3","1"],e+=""+n.Templates["AbstractSix.siril"](t)},n.Templates["Touch.select"]=function(t){var e="";t.touchRows=t.touchRows||1/0,t.touchRows-=2,t.styleUnreached=t.styleUnreached||"",t.styleFalse=t.styleFalse||"",e+='<option value="0">'+n.stringFromRow(t.object.getInitialRow())+"</option>";var i=t.object.getCourses();if(i)for(var o,r=-1,s=i.length-1;r<s;)e+='<option value="'+(o=i[r+=1]).getIndex()+'"',t.touchRows<=0&&(e+=' style="'+t.styleUnreached+'"'),t.falseness&&t.falseness.contains(o)&&(e+=' style="'+t.styleFalse+'"'),e+=">"+o.print("text")+"</option>",t.touchRows-=o.estimateRows();return e},n.Templates["Touch.siril"]=function(t){var e="",i=[],o=n.stringFromRow(n.rowFromString("",t.object.getInitialRow().length));t.touchRows=t.touchRows||1/0,t.touchRows-=2,e+="// Generated by Free Touch Pricker\n// https://github.com/simpleigh/touch-pricker\n\n// "+n.stringFromRow(t.object.getInitialRow())+"\n";var r=t.object.getCourses();if(r)for(var s=-1,a=r.length-1;s<a;)e+="// "+(u=r[s+=1]).print("text")+"\n";e+="\n"+t.object.getInitialRow().length+" bells\n\ncomposition = touch\n\nslow = +3.1.3.1.3\nquick = +1.3.1.3.1\nplain = +"+o.slice(-1)+"\nbob = +"+o.slice(-3,-2)+"\nsingle = +"+o.slice(-3)+"\n\n";var c=t.object.getCourses();if(c)for(var u,h=-1,l=c.length-1;h<l&&(u=c[h+=1],e+="course"+(h+1)+" = "+u.print("siril",{touchRows:t.touchRows}),i.push("course"+(h+1)),t.touchRows-=u.estimateRows(),!(t.touchRows<=0)););return e+="\ntouch = +3.1, "+i.join(", ")+"\n\nprove touch\n"},n.Templates["Touch.text"]=function(t){var e=n.stringFromRow(t.object.getInitialRow())+"\n",i=t.object.getCourses();if(i)for(var o=-1,r=i.length-1;o<r;)e+=""+i[o+=1].print("text",{end:"\n"});return e},n.Templates["Music.AbstractScheme.text"]=function(t){var e="",n=t.object.getMatchers();if(n)for(var i=-1,o=n.length-1;i<o;)e+=""+n[i+=1].print("text");return e},n.Templates["Music.Pattern.text"]=function(t){var e="";return void 0===t.end&&(t.end="\n"),t.object.getMatchCount()>0&&((t.object.isWildcardMatch()||t.object.getMatchCount()>1)&&(e+=t.object.getMatchCount()+" "),e+=""+t.object.getName()+t.end),e},n.Templates["Music.PatternGroup.text"]=function(t){var e="";if(t.object.getMatchCount()>0){if(e+=t.object.getMatchCount()+" "+t.object.getName(),t.object.getSubmatchCount()>0){e+=" (";var n=!0,i=t.object.getPatterns();if(i)for(var o,r=-1,s=i.length-1;r<s;)(o=i[r+=1])&&o.getMatchCount()>0&&(n||(e+=", "),e+=""+o.print("text",{end:""}),n=!1);e+=")"}e+="\n"}return e},n.Templates["Pricker.Mbd.css"]=function(t){return'#sixends { float: left; font-family: "Courier New", "Courier", "monospace"; font-size: 12pt; margin-right: 25px;}#controls { float: left; margin-right: 25px;}.tab { background-color: #EFEFF7; border-color: black; border-radius: 15px 0 0 0; border-style: solid; border-width: 1px 1px 0 1px; cursor: pointer; float: left; height: 20px; line-height: 20px; padding-left: 10px; padding-right: 8px; text-align: center;}.tab-selected { background-color: #BDBDE7; font-weight: bold;}#pages { width: 360px;}.page { border-color: black; border-style: solid; border-width: 1px; clear: left; display: none; padding: 9px; visibility: hidden; width: 340px;}.page-selected { display: block; visibility: visible;}.page div, .page div#savedCalling { margin-bottom: 20px;}.page div:last-of-type { margin-bottom: 0px;}.page form { height: 25px; margin-bottom: 10px;}.page textarea { border-width: 1px; height: 450px; padding: 1px; width: 336px;}#touch { background-color: #EFEFF7; float: left; padding: 10px;}.slowSix { background-color: #F0F0F8; cursor: pointer;}.quickSix { background-color: #E2E2F0; cursor: pointer;}.extraSix { color: #505050;}.falseBlock { color: red;}.musicalBlock { color: gold;}'},n.Templates["Pricker.Mbd.html"]=function(t){return'<div id="sixends"></div><div id="controls"> <div id="tabs"> <div id="tab_pricking" onclick="pricker.onTab(\'pricking\')" class="tab tab-selected">Pricking</div> <div id="tab_loadSave" onclick="pricker.onTab(\'loadSave\')" class="tab">Load/Save</div> <div id="tab_siril"    onclick="pricker.onTab(\'siril\')"    class="tab">Siril</div> <div id="tab_music"    onclick="pricker.onTab(\'music\')"    class="tab">Music</div><div id="tab_view"     onclick="pricker.onTab(\'view\')"     class="tab">View</div> </div> <div id="pages"> <div class="page page-selected" id="page_pricking"> <div> <label for="stage">Number of bells:</label> <select id="stage" onchange="pricker.onStage()"></select> </div> <div> Course from rounds: <div id="callingFromRounds"></div> </div> <div> From current start row: <div id="calling"></div> </div> <div> <form onsubmit="return false"> <label for="initialRow">Starting row:</label> <input type="text" id="initialRow" size="15" maxLength="15" /> <button onclick="pricker.onSetInitialRow()">Set</button> <button onclick="pricker.onResetInitialRow()">Reset</button> </form> </div> <div> <form onsubmit="return false"> <label for="courseLength">Course length:</label> <input type="text" id="courseLength" size="2" maxLength="2" /> <button onclick="pricker.onSetLength()">Set</button> <button onclick="pricker.onResetLength()">Reset</button> </form> </div> <div> <label for="callReset">Current calling:</label> <button id="callReset" onclick="pricker.onResetCalls()">Reset</button> </div> <div> Saved calling: <div id="savedCalling"></div> <button id="saveCalling" onclick="pricker.onSaveCalling()">Save</button> <button id="loadCalling" onclick="pricker.onLoadCalling()">Load</button> </div> </div> <div class="page" id="page_loadSave"> <form onsubmit="return false"> <button onclick="pricker.onLoadTouch()">Import</button> <button onclick="pricker.onSaveTouch()">Export</button> </form> <textarea id="loadSaveTextarea"></textarea> </div> <div class="page" id="page_siril"> <form onsubmit="return false"> <button onclick="pricker.onGenerateSiril()">Generate</button> </form> <textarea id="sirilTextarea"></textarea> </div> <div class="page" id="page_music"> <form onsubmit="return false"> <button onclick="pricker.onAnalyseMusic()">Analyse</button> </form> <textarea id="musicTextarea"></textarea> </div> <div class="page" id="page_view"> <input type="checkbox" id="showSixHeads" onclick="pricker.onShowSixHeads()"/> <label for="showSixHeads">Show six heads</label> </div> </div></div><div id="touch"> <div> <button onclick="pricker.onProve()">PROVE</button> <span id="proofResult"></span> </div> <div id="numRows"></div> <label> <input id="rolling" type="checkbox" /> Rolling course entry </label> <form onsubmit="return false"> <button onclick="pricker.onInsertCourse()">Insert</button> <button onclick="pricker.onPasteCourse()">Paste</button> <button onclick="pricker.onCopyCourse()">Copy</button> <button onclick="pricker.onCutCourse()">Cut</button> <button onclick="pricker.onDeleteCourse()">Delete</button> </form> <select id="courses"> </select> <form onsubmit="return false"> <button onclick="pricker.onInsertCourse()">Insert</button> <button onclick="pricker.onPasteCourse()">Paste</button> <button onclick="pricker.onCopyCourse()">Copy</button> <button onclick="pricker.onCutCourse()">Cut</button> <button onclick="pricker.onDeleteCourse()">Delete</button> </form></div>'},n});